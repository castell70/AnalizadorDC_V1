<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analizador de Datos Cualitativos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <script type="importmap">
  {
    "imports": {
      "papaparse": "https://esm.sh/papaparse@5.4.1",
      "d3": "https://esm.sh/d3@7.9.0",
      "jspdf": "https://esm.sh/jspdf@2.5.2",
      "html2canvas": "https://esm.sh/html2canvas@1.4.1",
      "mammoth": "https://esm.sh/mammoth@1.6.0",
      "xlsx": "https://esm.sh/xlsx@0.18.5",
      "pdfjs-dist": "https://esm.sh/pdfjs-dist@4.7.76",
      "docx": "https://esm.sh/docx@8.6.0"
    }
  }
  </script>
</head>
<body>
  <header class="app-header">
    <div class="app-title">Analizador de Datos Cualitativos</div>
    <div class="powered">Powered by ITCPO</div>
  </header>

  <nav class="top-menu">
    <button class="menu-btn active" data-view="carga">Cargar Archivos</button>
    <button class="menu-btn" data-view="categorias">Categorías Base</button>
    <button class="menu-btn" data-view="analisis">Ejecutar Análisis</button>
    <button class="menu-btn" data-view="red">Red Temática</button>
    <button class="menu-btn" data-view="reportes">Reportes</button>
    <button class="menu-btn" id="btn-reset">Reiniciar</button>
  </nav>

  <main class="container">
    <section id="view-carga" class="view visible">
      <div class="panel">
        <h2>1. Carga y preparación</h2>
        <p class="muted">Formatos: docx, pdf, xls, xlsx, csv, txt. (Los archivos .doc antiguos pueden no procesarse correctamente en el navegador.)</p>
        <label class="upload-area">
          <input id="file-input" type="file" multiple accept=".txt,.csv,.docx,.pdf,.xls,.xlsx" />
          <span class="upload-instructions">Arrastra y suelta o haz clic para seleccionar archivos</span>
        </label>
        <div id="files-list" class="list"></div>
        <div class="actions">
          <button id="btn-clear" class="btn secondary">Limpiar</button>
          <button id="btn-parse" class="btn primary">Procesar Archivos</button>
        </div>
      </div>

      <div class="panel">
        <h3>Previsualización y metadatos detectados</h3>
        <div id="preview" class="preview"></div>
      </div>
    </section>

    <section id="view-categorias" class="view">
      <div class="panel">
        <h2>2. Categorías base del plan de análisis</h2>
        <p class="muted">Edita o ingresa tus categorías base (una por línea). Puedes incluir sinónimos separados por " | ".</p>
        <textarea id="base-categories" rows="10" placeholder="Ejemplo:
Acceso a servicios|disponibilidad|cobertura
Participación comunitaria|liderazgo|organización
Percepción de riesgos|miedo|incertidumbre
Políticas públicas|programas|instituciones
Recursos y capacidades|financiamiento|infraestructura"></textarea>
        <div class="actions">
          <button id="btn-save-categories" class="btn primary">Guardar categorías</button>
        </div>
      </div>

      <!-- Sentiment chart panel -->
      <div class="panel">
        <h3>Análisis de sentimiento (global)</h3>
        <p class="muted">Distribución simple de sentimiento en los textos cargados: positivo, neutral y negativo.</p>
        <div id="sentiment-chart" style="height:220px;"></div>
      </div>
    </section>

    <section id="view-analisis" class="view">
      <div class="panel">
        <h2>3. Análisis</h2>
        <ol class="steps">
          <li>Lectura inicial y familiarización</li>
          <li>Codificación abierta</li>
          <li>Agrupación en categorías (incluye categorías emergentes)</li>
          <li>Análisis temático reflexivo (con citas)</li>
        </ol>
        <div class="actions">
          <button id="btn-run-analysis" class="btn success">Ejecutar análisis</button>
        </div>
      </div>

      <div class="panel">
        <h3>Resultados</h3>
        <div id="results" class="results">
          <div class="grid">
            <div>
              <h4>Lectura inicial</h4>
              <div id="familiarization"></div>
            </div>
            <div>
              <h4>Códigos iniciales</h4>
              <div id="open-codes"></div>
            </div>
            <div>
              <h4>Categorías</h4>
              <div id="categories"></div>
            </div>
            <div>
              <h4>Temas y subtemas</h4>
              <div id="themes"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-red" class="view">
      <div class="panel">
        <h2>4. Red temática</h2>
        <p class="muted">Ejes → Categorías → Subtemas → Códigos → Citas</p>
        <div class="actions">
          <button id="btn-refresh-network" class="btn primary">Actualizar Red</button>
          <button id="btn-nodes-main" class="btn">Principales</button>
          <button id="btn-nodes-cats" class="btn">Categorías</button>
          <button id="btn-nodes-all" class="btn">Todos</button>
          <button id="btn-zoom-in" class="btn">Zoom +</button>
          <button id="btn-zoom-out" class="btn">Zoom −</button>
          <button id="btn-reset-zoom" class="btn">Reset Zoom</button>
          <button id="btn-export-pdf" class="btn">Exportar PDF de red</button>
        </div>
        <div id="network" class="network"></div>
      </div>
    </section>

    <section id="view-reportes" class="view">
      <div class="panel">
        <h2>5. Reportes</h2>
        <div class="actions">
          <button id="btn-generate-docx" class="btn success">Generar Word</button>
        </div>
        <div id="report-preview" class="report"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span>Listo</span>
  </footer>

  <!-- Notification container -->
  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Floating help button -->
  <button id="help-btn" class="help-btn" title="Ayuda">?</button>
  <!-- Help modal -->
  <div id="help-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button id="help-close" class="modal-close" aria-label="Cerrar">×</button>
      <h2>Análisis cualitativos — Guía completa</h2>

      <p>Esta aplicación apoya el análisis cualitativo de materiales textuales (entrevistas, grupos focales, notas de campo, encuestas abiertas) mediante un flujo guiado que incluye carga y limpieza de archivos, definición de categorías base, extracción de códigos, identificación de categorías emergentes, síntesis temática, visualización en red y generación de reportes.</p>

      <h3>Resumen del flujo</h3>
      <ol>
        <li><strong>Cargar archivos:</strong> Suba documentos en formatos compatibles (.txt, .csv, .docx, .pdf, .xls, .xlsx). Tras procesarlos la herramienta extrae texto y metadatos heurísticos (país, edad, género, localidad).</li>
        <li><strong>Definir categorías base:</strong> En "Categorías base" ingrese sus categorías analíticas (una por línea). Puede añadir sinónimos usando " | " para mejorar la asignación automática de códigos.</li>
        <li><strong>Ejecutar análisis:</strong> Presione "Ejecutar análisis" para generar lectura inicial, códigos abiertos, agrupación en categorías (base + emergentes) y síntesis temática con citas representativas.</li>
        <li><strong>Refinar emergentes:</strong> Revise, elimine (×) o renombre emergentes directamente en el panel de Categorías; las vistas y el reporte se actualizan automáticamente.</li>
        <li><strong>Explorar la red temática:</strong> Use los filtros (Principales / Categorías / Todos), controles de zoom y arrastre de nodos para optimizar la disposición antes de exportar a PDF.</li>
        <li><strong>Generar reporte:</strong> En "Reportes" puede previsualizar y exportar un documento Word con lectura inicial, códigos, categorías, tablas de citas y una matriz ampliada de ejes emergentes.</li>
      </ol>

      <h3>Detalles y consejos por sección</h3>
      <h4>1. Carga y preparación</h4>
      <ul>
        <li>Preferible: convertir archivos .doc antiguos a .docx para mejor compatibilidad.</li>
        <li>Al procesar, la aplicación extrae texto y crea una previsualización; revise el snippet para verificar la calidad del OCR/extraído.</li>
        <li>Si algún archivo falla, el previsualizador mostrará un mensaje de error por archivo para actuar sobre él.</li>
      </ul>

      <h4>2. Categorías base</h4>
      <ul>
        <li>Escriba cada categoría en una línea; incluya sinónimos separados por " | " (ej. Acceso a servicios | disponibilidad | cobertura).</li>
        <li>Las categorías base sirven como punto de partida para agrupar códigos; las emergentes complementan el plan analítico si aparecen patrones no previstos.</li>
        <li>El panel incluye una gráfica de sentimiento (Positivo/Neutral/Negativo) que resume las oraciones detectadas en los textos procesados — revísela para validar la heurística; ajuste categorías si es necesario.</li>
      </ul>

      <h4>3. Ejecutar Análisis</h4>
      <ul>
        <li>La función realiza tres tareas principales: extracción de oraciones y códigos (codificación abierta), asignación a categorías base mediante coincidencia léxica, y detección de categorías emergentes usando agrupamiento (k-means sobre TF–IDF).</li>
        <li>Resultados mostrados: lectura inicial (resúmenes por documento), lista de códigos iniciales (clic en "×" elimina códigos si desea excluirlos), panel de categorías (base y emergentes) y temas sintetizados con citas.</li>
        <li>Eliminar o renombrar emergentes: utilice la X para excluir una emergente del análisis; haga clic sobre su nombre para editarlo en línea y propagar el cambio a la red y al reporte.</li>
      </ul>

      <h4>4. Red temática</h4>
      <ul>
        <li>La red representa la jerarquía Ejes → Categorías → Subtemas → Códigos → Citas.</li>
        <li>Filtros: "Principales" muestra ejes, categorías y subtemas; "Categorías" deja solo ejes y categorías; "Todos" muestra la red completa con códigos y citas.</li>
        <li>Controles de zoom: Zoom + / Zoom − / Reset permiten ajustar la escala visual; utilícelos para inspeccionar detalles antes de exportar.</li>
        <li>Arrastre nodos con el ratón o el dedo para mejorar la disposición; la exportación a PDF intentará preservar la escala y la disposición visible.</li>
        <li>Exportar a PDF: genera un PDF optimizado (imagen rasterizada dentro de la página) con límites de tamaño para mantener el archivo legible y de peso razonable; si necesita más detalle, aumente el Zoom y vuelva a exportar o ajuste la disposición de nodos.</li>
      </ul>

      <h4>5. Reportes y generación de Word</h4>
      <ul>
        <li>El Word generado incluye: título, lectura inicial, códigos, listado de categorías con ejemplos de códigos, temas y subtemas con citas, una tabla de categorías–códigos–citas y una matriz ampliada de ejes emergentes (conteos, términos frecuentes y ejemplos).</li>
        <li>Si ha eliminado o renombrado emergentes, el documento reflejará esos cambios si genera el reporte tras las modificaciones.</li>
      </ul>

      <h3>Cómo interpretar resultados y validar calidad</h3>
      <ul>
        <li>La extracción y agrupamiento son heurísticos y automatizados: revise siempre las citas y los subtemas para validar la coherencia interpretativa.</li>
        <li>La heurística de sentimiento es simple (lexical y ventana de negaciones); usela como orientación inicial y compleméntela con lectura cualitativa de las citas.</li>
        <li>Si detecta que códigos recurrentes se asignan incorrectamente a una categoría, renombre o elimine emergentes y vuelva a ejecutar la actualización de la red y el reporte.</li>
      </ul>

      <h3>Buenas prácticas</h3>
      <ul>
        <li>Procese lotes manejables de documentos para mantener rendimiento y calidad de agrupamiento (evite cargas masivas únicas si es posible).</li>
        <li>Defina categorías base antes de ejecutar análisis para guiar la agrupación; luego use emergentes para ampliar hallazgos inesperados.</li>
        <li>Antes de exportar PDF de la red, ajuste zoom y mueva nodos: eso mejora la legibilidad en el documento final.</li>
        <li>Guarde y documente los cambios (eliminaciones y renombrados de emergentes) para trazabilidad del proceso analítico.</li>
      </ul>

      <h3>Solución de problemas comunes</h3>
      <ul>
        <li>Archivo .doc no se procesa correctamente: convierta a .docx y vuelva a cargar.</li>
        <li>La gráfica de sentimiento no coincide con su lectura: revise la presencia de ironía, negaciones complejas o léxico contextual (la heurística es limitada).</li>
        <li>PDF de la red muy grande o ilegible: reduzca contenido con el filtro "Categorías" o "Principales", ajuste Zoom y vuelva a exportar; el exportador limita dimensiones para evitar PDFs demasiado pesados.</li>
        <li>Renombrado no se refleja: asegúrese de pulsar Enter o perder el foco del campo de edición para aplicar el cambio; la vista y el reporte se actualizan automáticamente.</li>
      </ul>

      <h3>Seguridad y límites técnicos</h3>
      <ul>
        <li>Todo el procesamiento sucede en el navegador; los datos no se envían a servidores externos por defecto.</li>
        <li>El rendimiento depende de recursos del equipo: archivos muy grandes o muchos documentos pueden requerir más tiempo y memoria.</li>
      </ul>

      <p class="small">Si necesita asistencia técnica o desea adaptar reglas de extracción y léxico al dominio de su estudio, documente los casos que no encajen y considere ajustar las listas léxicas o realizar una revisión manual de los códigos antes del informe final.</p>

      <p class="small">© 2025 Carlos Alfredo Castillo Flores, CEO de ITCPO. Todos los derechos reservados.</p>
    </div>
  </div>
  <!-- Confirm reset modal -->
  <div id="confirm-reset-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Confirmar reinicio</h3>
      <p>Esta acción eliminará todos los archivos cargados y resultados del análisis. ¿Desea continuar?</p>
      <div class="actions">
        <button id="confirm-reset-no" class="btn">No, cancelar</button>
        <button id="confirm-reset-yes" class="btn primary">Sí, reiniciar</button>
      </div>
    </div>
  </div>

  <script type="module" src="./app.js"></script>
</body>
</html>